<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<!-- saved from url=(0054)http://www.webappsec.org/projects/articles/071105.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">



<title>DOM Based Cross Site Scripting</title>

<style type="text/css">
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:Tahoma;
	panose-1:2 11 6 4 3 5 4 4 2 4;}
@font-face
	{font-family:"Lucida Console";
	panose-1:2 11 6 9 4 5 4 2 2 4;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0in;
	margin-bottom:.0001pt;
	font-size:12.0pt;
	font-family:"Times New Roman";}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;}
div.Section1
	{page:Section1;}
 /* List Definitions */
 ol
	{margin-bottom:0in;}
ul
	{margin-bottom:0in;}
-->
</style>

<style type="text/css"></style></head>

<body lang="EN-US">

<div class="Section1">

<p class="MsoNormal" style="text-align:center"><span style="font-size:28.0pt">DOM Based Cross Site Scripting</span></p>

<p class="MsoNormal" style="text-align:center"><span style="font-size:28.0pt">or</span></p>

<p class="MsoNormal" style="text-align:center"><span style="font-size:28.0pt">XSS of the Third Kind</span></p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal" style="text-align:center"><span style="font-size:18.0pt">A look at an overlooked flavor of XSS</span></p>

<p class="MsoNormal" style="text-align:center"><span style="font-size:18.0pt">&nbsp;</span></p>

<p class="MsoNormal" style="text-align:center"><span style="font-size:18.0pt">Amit Klein, July 2005</span></p>

<p class="MsoNormal" style="text-align:center"><span style="font-size:18.0pt">&nbsp;</span></p>

<p class="MsoNormal"><b>Version: 0.2.8</b></p>

<p class="MsoNormal"><b>Last modified: </b><b>4th of July, 2005</b></p>

<p class="MsoNormal"><span style="text-decoration:none">&nbsp;</span></p>

<p class="MsoNormal"><b>Summary</b></p>

<p class="MsoNormal">We all know what Cross Site Scripting (XSS) is, right? It’s
that vulnerability wherein one sends malicious data (typically HTML stuff with Javascript
code in it) that is echoed back later by the application in an HTML context of
some sort, and the Javascript code gets executed. Well, wrong. There’s a kind
of XSS which does not match this description, at least not in some fundamental
properties. The XSS attacks described above are either “non-persistent”/“reflected”
(i.e. the malicious data is embedded in the page that is returned to the
browser immediately following the request) or “persistent”/“stored” (in which
case the malicious data is returned at some later time). But there’s also a
third kind of XSS attacks - the ones that do not rely on sending the malicious
data to the server in the first place! While this seems almost contradictory to
the definition or to common sense, there are, in fact, two well described
examples for such attacks. This technical note discusses the third kind of XSS,
dubbed “DOM Based XSS”. No claim is made to novelty in the attacks themselves,
of course, but rather, the innovation in this write-up is about noticing that
these belong to a different flavor, and that flavor is interesting and
important. </p>

<p class="MsoNormal">Application developers and owners need to understand DOM
Based XSS, as it represents a threat to the web application, which has
different preconditions than standard XSS. As such, there are many web
applications on the Internet that are vulnerable to DOM Based XSS, yet when
tested for (standard) XSS, are demonstrated to be “not vulnerable”. Developers
and site maintainers (and auditors) need to familiarize themselves with
techniques to detect DOM Based XSS vulnerabilities, as well as with techniques
to defend against them, both therewhich are different than the ones applicable
for standard XSS.</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal"><b>Introduction</b></p>

<p class="MsoNormal">The reader is assumed to possess basic knowledge of XSS (<a href="http://www.webappsec.org/projects/articles/071105.html#r1">[1]</a>,
<a href="http://www.webappsec.org/projects/articles/071105.html#r2">[2]</a>, <a href="http://www.webappsec.org/projects/articles/071105.html#r3">[3]</a>, <a href="http://www.webappsec.org/projects/articles/071105.html#r4">[4]</a>, <a href="http://www.webappsec.org/projects/articles/071105.html#r8">[8]</a>). XSS is typically categorized into “non-persistent” and “persistent”
(<a href="http://www.webappsec.org/projects/articles/071105.html#r3">[3]</a>, “reflected” and “stored” accordingly, as defined in <a href="http://www.webappsec.org/projects/articles/071105.html#r4">[4]</a>). “Non-persistent”
means that the malicious (Javascript) payload is echoed by the server in an
immediate response to an HTTP request from the victim. “Persistent” means that
the payload is stored by the system, and may later be embedded by the
vulnerable system in an HTML page provided to a victim. As mentioned in the
summary, this categorization assumes that a fundamental property of XSS is
having the malicious payload move from the browser to the server and back to
the same (in non-persistent XSS) or any (in persistent XSS) browser. This paper
points out that this is a misconception. While there are not many
counterexamples in the wild, the mere existence of XSS attacks which do not
rely on the payload embedded by the server in some response page, is of
importance as it has a significant impact on detection and protection methods.
This is discussed in the document.</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal"><b>Example and Discussion</b></p>

<p class="MsoNormal">Before describing the basic scenario, it is important to
stress that the techniques outlined here were already demonstrated in public (e.g.
<a href="http://www.webappsec.org/projects/articles/071105.html#r5">[5]</a>, <a href="http://www.webappsec.org/projects/articles/071105.html#r6">[6]</a> and <a href="http://www.webappsec.org/projects/articles/071105.html#r7">[7]</a>). As such, it is not claimed that the below are new techniques
(although perhaps some of the evasion techniques are).</p>

<p class="MsoNormal">The prerequisite is for the vulnerable site to have an HTML
page that uses data from the <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.location</span>
or <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.URL</span>
or <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.referrer</span>
(or any various other objects which the attacker can influence) in an insecure
manner.</p>

<p class="MsoNormal" style="margin-left:.5in">NOTE for readers unfamiliar with
those Javascript objects: when Javascript is executed at the browser, the
browser provides the Javascript code with several objects that represent the
DOM (Document Object Model). The <span style="font-size:10.0pt;font-family:
&quot;Lucida Console&quot;">document</span> object is chief among those objects, and it
represents most of the page’s properties, as experienced by the browser. This <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document</span> object
contains many sub-objects, such as <span style="font-size:10.0pt;font-family:
&quot;Lucida Console&quot;">location</span>, <span style="font-size:10.0pt;font-family:
&quot;Lucida Console&quot;">URL</span> and <span style="font-size:10.0pt;font-family:
&quot;Lucida Console&quot;">referrer</span>. These are populated by the browser according
to the browser’s point of view (this is significant, as we’ll see later with
the fragments). So, <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.URL</span>
and <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.location</span>
are populated with the URL of the page, as the browser understands it. Notice
that these objects are not extracted of the HTML body - they do not appear in
the page data. The <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document</span>
object does contain a <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">body</span>
object that is a representation of the parsed HTML.</p>

<p class="MsoNormal" style="margin-left:.5in">It is not uncommon to find an
application HTML page containing Javascript code that parses the URL line (by
accessing <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.URL</span>
or <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.location</span>)
and performs some client side logic according to it. The below is an example to
such logic.</p>

<p class="MsoNormal">In analogy to the example in <a href="http://www.webappsec.org/projects/articles/071105.html#r2">[2]</a> (and as an essentially identical
scenario to the one in <a href="http://www.webappsec.org/projects/articles/071105.html#r7">[7]</a>), consider, for example, the following HTML page
(let’s say this is the content of <span style="font-size:10.0pt;font-family:
&quot;Lucida Console&quot;">http://www.vulnerable.site/welcome.html</span>):</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&lt;HTML&gt;</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&lt;TITLE&gt;Welcome!&lt;/TITLE&gt;</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">Hi</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&lt;SCRIPT&gt;</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">var pos=document.URL.indexOf("name=")+5;</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">document.write(document.URL.substring(pos,document.URL.length));</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&lt;/SCRIPT&gt;</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&lt;BR&gt;<br>
Welcome to our system</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">…</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&lt;/HTML&gt;</span></p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal">Normally, this HTML page would be used for welcoming the
user, e.g.: </p>

<p class="MsoNormal" style="text-indent:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="text-indent:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">http://www.vulnerable.site/welcome.html?name=Joe</span></p>

<p class="MsoNormal" style="text-indent:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&nbsp;</span></p>

<p class="MsoNormal">However, a request such as:</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">http://www.vulnerable.site/welcome.html?name=</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&lt;script&gt;alert(document.cookie)&lt;/script&gt;
</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&nbsp;</span></p>

<p class="MsoNormal">would result in an XSS condition. Let’s see why: the
victim’s browser receives this link, sends an HTTP request to <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">www.vulnerable.site</span>,
and receives the above (static!) HTML page. The victim’s browser then starts
parsing this HTML into DOM. The DOM contains an object called document, which
contains a property called URL, and this property is populated with the URL of
the current page, as part of DOM creation. When the parser arrives to the Javascript
code, it executes it and it modifies the raw HTML of the page. In this case,
the code references <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.URL</span>,
and so, a part of this string is embedded at parsing time in the HTML, which is
then immediately parsed and the Javascript code found (<span style="font-size:
10.0pt;font-family:&quot;Lucida Console&quot;">alert(…)</span>) is executed in the
context of the same page, hence the XSS condition. </p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal">Notes:</p>

<p class="MsoNormal">1. The malicious payload was not embedded in the raw HTML
page at any time (unlike the other flavors of XSS).</p>

<p class="MsoNormal">2. This exploit only works if the browser does not modify
the URL characters. Mozilla automatically encodes <span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&lt;</span> and <span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&gt;</span> (into <span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">%3C</span> and <span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">%3E</span>, respectively) in the <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.URL</span> when
the URL is not directly typed at the address bar, and therefore it is not
vulnerable to the attack as shown in the example. It is vulnerable to attacks
if <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">&lt;</span> and <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">&gt;</span> are not
needed (in raw form). Microsoft Internet Explorer 6.0 does not encode <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">&lt;</span> and <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">&gt;</span>, and is
therefore vulnerable to the attack as-is.</p>

<p class="MsoNormal">Of course, embedding in the HTML directly is just one attack
mount point, there are various scenarios that do not require <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">&lt;</span> and <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">&gt;</span>, and
therefore Mozilla in general is not immune from this attack.</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal"><b>Evading standard detection and prevention technologies</b></p>

<p class="MsoNormal">In the above example, it may be argued that still, the
payload did arrive to the server (in the query part of the HTTP request), and
so it can be detected just like any other XSS attack. But even that can be
taken care of. Consider the following attack:</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">http://www.vulnerable.site/welcome.html#name=</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&lt;script&gt;alert(document.cookie)&lt;script&gt;</span></p>

<p class="MsoNormal" style="margin-left:.5in">&nbsp;</p>

<p class="MsoNormal">Notice the number sign (<span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">#</span>) right after the file name. It tells the
browser that everything beyond it is a fragment, i.e. not part of the query.
Microsoft Internet Explorer (6.0) and Mozilla do not send the fragment to the
server, and therefore, the server would see the equivalent of <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">http://www.vulnerable.site/welcome.html</span>,
so the payload would not even be seen by the server. We see, therefore, that
this evasion technique causes the major browsers not to send the malicious
payload to the server.</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal">Sometimes, it’s impossible to completely hide the payload: in
<a href="http://www.webappsec.org/projects/articles/071105.html#r5">[5]</a> and <a href="http://www.webappsec.org/projects/articles/071105.html#r6">[6]</a>, the malicious payload is part of the username, in a URL that looks
like <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">http://username@host/</span>.
The browser, in such case, sends a request with Authorization header containing
the username (the malicious payload), and thus, the payload does arrive to the
server (Base64 encoded - so IDS/IPS would need to decode this data first in
order to observe the attack). Still, the server is not required to embed this
payload in order for the XSS condition to occur.</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal">Obviously, in situations where the payload can be completely
hidden, online detection (IDS) and prevention (IPS, web application firewalls)
products cannot fully defend against this attack, assuming the vulnerable
script can indeed be invoked from a known location. Even if the payload has to
be sent to the server, in many cases it can be crafted in such way to avoid
being detected, e.g. if a specific parameter is protected (e.g. the name
parameter in the above example), then a slight variation of the attack may
succeed:</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">http://www.vulnerable.site/welcome.html?notname=</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&lt;script&gt;(document.cookie)&lt;/script&gt;</span></p>

<p class="MsoNormal" style="margin-left:.5in">&nbsp;</p>

<p class="MsoNormal">A more strict security policy would require that the name
parameter be sent (to avoid the above tricks with names and number sign). We
can therefore send this:</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">http://www.vulnerable.site/welcome.html?notname=</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&lt;script&gt;alert(document.cookie)&lt;script&gt;&amp;name=Joe</span></p>

<p class="MsoNormal" style="margin-left:.5in">&nbsp;</p>

<p class="MsoNormal">If the policy restricts the additional parameter name (e.g. to
<span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">foobar</span>),
then the following variant would succeed:</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">http://www.vulnerable.site/welcome.html?foobar=</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">name=&lt;script&gt;alert(document.cookie)&lt;script&gt;&amp;name=Joe</span></p>

<p class="MsoNormal" style="margin-left:.5in">&nbsp;</p>

<p class="MsoNormal">Note that the ignored parameter (<span style="font-size:
10.0pt;font-family:&quot;Lucida Console&quot;">foobar</span>) must come first, and it
contains the payload in its value.</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal">The scenario in <a href="http://www.webappsec.org/projects/articles/071105.html#r7">[7]</a> is even better from the attacker’s
perspective, since the full <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.location</span>
is written to the HTML page (the Javascript code does not scan for a specific
parameter name). Therefore, the attacker can completely hide the payload e.g.
by sending:</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">/attachment.cgi?id=&amp;action=</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">foobar#&lt;script&gt;alert(document.cookie)&lt;/script&gt;</span></p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal">Even if the payload is inspected by the server, protection
can be guaranteed only if the request in its fullness is denied, or if the
response is replaced with some error text. Consider <a href="http://www.webappsec.org/projects/articles/071105.html#r5">[5]</a> and <a href="http://www.webappsec.org/projects/articles/071105.html#r6">[6]</a> again, if the
Authorization header is simply removed by an intermediate protection system, it
has no effect as long as the original page is returned. Likewise, any attempt
to sanitize the data on the server, either by removing the offending characters
or by encoding them, is ineffective against this attack.</p>

<p class="MsoNormal">In the case of <span style="font-size:10.0pt;font-family:
&quot;Lucida Console&quot;">document.referrer</span>, the payload is sent to the server
through the Referer header. However, if the user’s browser, or an intermediate
device eliminates this header, then there’s no trace of the attack - it may go
completely unnoticed.</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal">To generalize, traditional methods of:</p>

<ol style="margin-top:0in">
 <li class="MsoNormal">HTML encoding output data at the server side</li>
 <li class="MsoNormal">Removing/encoding offending input data at the server side</li>
</ol>

<p class="MsoNormal">Do not work well against DOM Based XSS. </p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal">Regarding automatic vulnerability assessment by way of fault
injection (sometimes called fuzzing) won’t work, since products that use this
technology typically evaluate the results according to whether the injected
data is present in the response page or not (rather than execute the client
side code in a browser context and observe the runtime effects). However, if a
product is able to statically analyze a Javascript found in a page, then it may
point out suspicious patterns (see below). And of course, if the product can
execute the Javascript (and correctly populating the DOM objects), or simulate
such execution, then it can detect this attack.</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal">Manual vulnerability assessment using a browser would work
because the browser would execute the client side (Javascript) code. Of course,
a vulnerability assessment product may adopt this kind of technology and execute
client side code to inspect the runtime effects.</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal"><b>Effective defenses</b></p>

<p class="MsoNormal">1. Avoiding client side document rewriting, redirection, or
other sensitive actions, using client side data. Most of these effects can be achieved
by using dynamic pages (server side).</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal">2. Analyzing and hardening the client side (Javascript)
code. Reference to DOM objects that may be influenced by the user (attacker)
should be inspected, including (but not limited to):</p>

<ul style="margin-top:0in">
 <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.URL</span></li>
 <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.URLUnencoded</span></li>
 <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.location
     (and many of its properties)</span></li>
 <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.referrer</span></li>
 <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">window.location
     (and many of its properties)</span></li>
</ul>

<p class="MsoNormal">Note that a document object property or a window object
property may be referenced syntactically in many ways - explicitly (e.g. <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">window.location</span>),
implicitly (e.g. <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">location</span>),
or via obtaining a handle to a window and using it (e.g. <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">handle_to_some_window.location</span>).</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal">Special attention should be given to scenarios wherein the
DOM is modified, either explicitly or potentially, either via raw access to the
HTML or via access to the DOM itself, e.g. (by no means an exhaustive list,
there are probably various browser extensions):</p>

<ul style="margin-top:0in">
 <li class="MsoNormal">Write raw HTML, e.g.:
 <ul style="margin-top:0in">
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.write(…)</span></li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.writeln(…)</span></li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.body.innerHtml=…</span></li>
 </ul>
 </li>
 <li class="MsoNormal">Directly modifying the DOM (including DHTML events), e.g.:
 <ul style="margin-top:0in">
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.forms[0].action=…
      </span>(and various other collections)</li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.attachEvent(…)</span></li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.create…(…)</span></li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.execCommand(…)</span></li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.body.
      … </span>(accessing the DOM through the body object)</li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">window.attachEvent(…)</span></li>
 </ul>
 </li>
 <li class="MsoNormal">Replacing the document URL, e.g.:
 <ul style="margin-top:0in">
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.location=…
      </span>(and assigning to location’s href, host and hostname)</li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.location.hostname=…</span></li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.location.replace(…)</span></li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.location.assign(…)</span></li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.URL=…</span></li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">window.navigate(…)</span></li>
 </ul>
 </li>
 <li class="MsoNormal">Opening/modifying a window, e.g.:
 <ul style="margin-top:0in">
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">document.open(…)</span></li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">window.open(…)</span></li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">window.location.href=…
      </span>(and assigning to location’s href, host and hostname)</li>
 </ul>
 </li>
 <li class="MsoNormal">Directly executing script, e.g.:
 <ul style="margin-top:0in">
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">eval(…)</span></li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">window.execScript(…)</span></li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">window.setInterval(…)</span></li>
  <li class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;">window.setTimeout(…)</span></li>
 </ul>
 </li>
</ul>

<p class="MsoNormal" style="margin-left:.25in">&nbsp;</p>

<p class="MsoNormal">To continue the above example, an effective defense can be
replacing the original script part with the following code, which verifies that
the string written to the HTML page consists of alphanumeric characters only:</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&lt;SCRIPT&gt;</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">var pos=document.URL.indexOf("name=")+5;</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">var name=document.URL.substring(pos,document.URL.length);</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">if (name.match(/^[a-zA-Z0-9]</span><span dir="RTL"></span><span lang="HE" dir="RTL" style="font-size:10.0pt"><span dir="RTL"></span>*</span><span dir="LTR"></span><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;"><span dir="LTR"></span>$/))</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">{</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;document.write(name);</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">}</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">else</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">{</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;window.alert("Security error");</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">}</span></p>

<p class="MsoNormal" style="margin-left:.5in"><span style="font-size:10.0pt;
font-family:&quot;Lucida Console&quot;">&lt;/SCRIPT&gt;</span></p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal">Such functionality can (and perhaps should) be provided
through a generic library for sanitation of data (i.e. a set of Javascript
functions that perform input validation and/or sanitation). The downside is
that the security logic is exposed to the attackers - it is embedded in the
HTML code. This makes it easier to understand and to attack it. While in the
above example, the situation is very simple, in more complex scenarios wherein
the security checks are less than perfect, this may come to play.</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal">3. Employing a very strict IPS policy in which, for example,
page welcome.html is expected to receive a one only parameter named “name”,
whose content is inspected, and any irregularity (including excessive
parameters or no parameters) results in not serving the original page, likewise
with any other violation (such as an Authorization header or Referer header
containing problematic data), the original content must not be served. And in
some cases, even this cannot guarantee that an attack will be thwarted.</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal"><b>A note about redirection vulnerabilities</b></p>

<p class="MsoNormal">The above discussion is on XSS, yet in many cases, merely
using a client side script to (insecurely) redirect the browser to another location
is considered vulnerability in itself. In such cases, the above techniques and
observations still apply.</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal"><b>Conclusion</b></p>

<p class="MsoNormal">While most XSS attacks described in public do indeed depend
on the server physically embedding user data into the response HTML pages,
there are XSS attacks that do not rely on server side embedding of the data.
This has material significance when discussing ways to detect and prevent XSS.
To date, almost all detection and prevention techniques discussed in public
assume that XSS implies that the server receives malicious user input and
embeds it in an HTML page. Since this assumption doesn’t hold (or only very
partially holds) for the XSS attacks described in this paper, many of the
techniques fail to detect and prevent this kind of attacks.</p>

<p class="MsoNormal">The XSS attacks that rely on server side embedding of user
data are categorized into “non-persistent” (or “reflected”) and “persistent”
(or “stored”). It is thus suggested that the third kind of XSS, the one that
does not rely on server side embedding, be named “DOM Based XSS”.</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal">Here is a comparison between standard XSS and DOM Based XSS:</p>

<p class="MsoNormal">&nbsp;</p>

<table class="MsoTableGrid" border="1" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border:none">
 <tbody><tr>
  <td valign="top" style="width:2.05in;border:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt">
  <p class="MsoNormal">&nbsp;</p>
  </td>
  <td valign="top" style="width:2.05in;border:solid windowtext 1.0pt;
  border-left:none;padding:0in 5.4pt 0in 5.4pt">
  <p class="MsoNormal">Standard XSS</p>
  </td>
  <td valign="top" style="width:2.05in;border:solid windowtext 1.0pt;
  border-left:none;padding:0in 5.4pt 0in 5.4pt">
  <p class="MsoNormal">DOM Based XSS</p>
  </td>
 </tr>
 <tr>
  <td valign="top" style="width:2.05in;border:solid windowtext 1.0pt;
  border-top:none;padding:0in 5.4pt 0in 5.4pt">
  <p class="MsoNormal">Root cause</p>
  </td>
  <td valign="top" style="width:2.05in;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt">
  <p class="MsoNormal">Insecure embedding of client input in HTML outbound page</p>
  </td>
  <td valign="top" style="width:2.05in;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt">
  <p class="MsoNormal">Insecure reference and use (in a client side code) of DOM objects
  that are not fully controlled by the server provided page</p>
  </td>
 </tr>
 <tr>
  <td valign="top" style="width:2.05in;border:solid windowtext 1.0pt;
  border-top:none;padding:0in 5.4pt 0in 5.4pt">
  <p class="MsoNormal">Owner</p>
  </td>
  <td valign="top" style="width:2.05in;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt">
  <p class="MsoNormal">Web developer (CGI)</p>
  </td>
  <td valign="top" style="width:2.05in;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt">
  <p class="MsoNormal">Web developer (HTML)</p>
  </td>
 </tr>
 <tr>
  <td valign="top" style="width:2.05in;border:solid windowtext 1.0pt;
  border-top:none;padding:0in 5.4pt 0in 5.4pt">
  <p class="MsoNormal">Page nature</p>
  </td>
  <td valign="top" style="width:2.05in;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt">
  <p class="MsoNormal">Dynamic only (CGI script)</p>
  </td>
  <td valign="top" style="width:2.05in;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt">
  <p class="MsoNormal">Typically static (HTML), but not necessarily.</p>
  </td>
 </tr>
 <tr>
  <td valign="top" style="width:2.05in;border:solid windowtext 1.0pt;
  border-top:none;padding:0in 5.4pt 0in 5.4pt">
  <p class="MsoNormal">Vulnerability Detection</p>
  </td>
  <td valign="top" style="width:2.05in;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt">
  <ul style="margin-top:0in">
   <li class="MsoNormal">Manual Fault injection</li>
   <li class="MsoNormal">Automatic Fault Injection</li>
   <li class="MsoNormal">Code Review (need access to the page source)</li>
  </ul>
  </td>
  <td valign="top" style="width:2.05in;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt">
  <ul style="margin-top:0in">
   <li class="MsoNormal">Manual Fault Injection</li>
   <li class="MsoNormal">Code Review (can be done remotely!)</li>
  </ul>
  </td>
 </tr>
 <tr>
  <td valign="top" style="width:2.05in;border:solid windowtext 1.0pt;
  border-top:none;padding:0in 5.4pt 0in 5.4pt">
  <p class="MsoNormal">Attack detection</p>
  </td>
  <td valign="top" style="width:2.05in;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt">
  <ul style="margin-top:0in">
   <li class="MsoNormal">Web server logs</li>
   <li class="MsoNormal">Online attack detection tools (IDS, IPS, web application
       firewalls)</li>
  </ul>
  </td>
  <td valign="top" style="width:2.05in;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt">
  <p class="MsoNormal">If evasion techniques are applicable and used - no server
  side detection is possible</p>
  </td>
 </tr>
 <tr>
  <td valign="top" style="width:2.05in;border:solid windowtext 1.0pt;
  border-top:none;padding:0in 5.4pt 0in 5.4pt">
  <p class="MsoNormal">Effective defense</p>
  </td>
  <td valign="top" style="width:2.05in;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt">
  <ul style="margin-top:0in">
   <li class="MsoNormal">Data validation at the server side</li>
   <li class="MsoNormal">Attack prevention utilities/tools (IPS, application
       firewalls)</li>
  </ul>
  </td>
  <td valign="top" style="width:2.05in;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt">
  <ul style="margin-top:0in">
   <li class="MsoNormal">Data validation at the client side (in Javascript)</li>
   <li class="MsoNormal">Alternative server side logic</li>
  </ul>
  </td>
 </tr>
</tbody></table>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal"><b>References</b></p>

<p class="MsoNormal">Note: the URLs below are up to date at the time of writing (July 4<sup>th</sup>, 2005). Some of these materials are live documents, and as such may
be updated to reflect the insights of this paper.</p>

<p class="MsoNormal" id="r1">[1] “CERT Advisory CA-2000-02 - Malicious HTML Tags Embedded
in Client Web Requests”, CERT, February 2<sup>nd</sup>, 2000</p>

<p class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;"><a href="http://www.cert.org/advisories/CA-2000-02.html">http://www.cert.org/advisories/CA-2000-02.html</a></span></p>

<p class="MsoNormal" id="r2">[2] “Cross Site Scripting Explained”, Amit Klein, June 2002</p>

<p class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;"><a href="http://crypto.stanford.edu/cs155/CSS.pdf">http://crypto.stanford.edu/cs155/CSS.pdf</a></span></p>

<p class="MsoNormal" id="r3">[3] “Cross-Site Scripting”, Web Application Security Consortium,
 February 23<sup>rd</sup>, 2004</p>

<p class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;"><a href="http://www.webappsec.org/projects/threat/classes/cross-site_scripting.shtml">http://www.webappsec.org/projects/threat/classes/cross-site_scripting.shtml</a></span></p>

<p class="MsoNormal" id="r4">[4] “Cross Site Scripting (XSS) Flaws”, The OWASP
Foundation, updated 2004 <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;"><a href="http://www.owasp.org/documentation/topten/a4.html">http://www.owasp.org/documentation/topten/a4.html</a></span></p>

<p class="MsoNormal" id="r5">[5] “Thor Larholm security advisory TL#001 (IIS allows universal CrossSiteScripting)”, Thor Larholm,
 April 10<sup>th</sup>, 2002</p>

<p class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;"><a href="http://www.cgisecurity.com/archive/webservers/iis_xss_4_5_and_5.1.txt">http://www.cgisecurity.com/archive/webservers/iis_xss_4_5_and_5.1.txt</a></span></p>

<p class="MsoNormal">(see also Microsoft Security Bulletin MS02-018  <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;"><a href="http://www.microsoft.com/technet/security/bulletin/MS02-018.mspx">http://www.microsoft.com/technet/security/bulletin/MS02-018.mspx</a></span>)</p>

<p class="MsoNormal" id="r6">[6] “ISA Server Error Page Cross Site Scripting”, Brett
Moore, July 16<sup>th</sup>, 2003 <span style="font-size:10.0pt;font-family:
&quot;Lucida Console&quot;"><a href="http://www.security-assessment.com/Advisories/ISA%20XSS%20Advisory.pdf">http://www.security-assessment.com/Advisories/ISA%20XSS%20Advisory.pdf</a></span></p>

<p class="MsoNormal">(see also Microsoft Security Bulletin MS03-028 <span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;"><a href="http://www.microsoft.com/technet/security/bulletin/MS03-028.mspx">http://www.microsoft.com/technet/security/bulletin/MS03-028.mspx</a>
</span>and a more elaborate description in “Microsoft ISA Server HTTP error
handler XSS”, Thor Larholm, July 16<sup>th</sup>, 2003 <span style="font-size:
10.0pt;font-family:&quot;Lucida Console&quot;"><a href="http://www.securityfocus.com/archive/1/329273">http://www.securityfocus.com/archive/1/329273</a></span>)</p>

<p class="MsoNormal" id="r7">[7] “Bugzilla Bug 272620 - XSS vulnerability in internal
error messages”<span lang="EN">, reported by Michael Krax, </span><span lang="EN">December 23<sup>rd</sup>, 2004</span></p>

<p class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=272620">https://bugzilla.mozilla.org/show_bug.cgi?id=272620</a></span></p>

<p class="MsoNormal" id="r8">[8] “The Cross Site Scripting FAQ”, Robert Auger, May 2002
(revised August 2003)</p>

<p class="MsoNormal"><span style="font-size:10.0pt;font-family:&quot;Lucida Console&quot;"><a href="http://www.cgisecurity.com/articles/xss-faq.shtml">http://www.cgisecurity.com/articles/xss-faq.shtml</a></span></p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal">&nbsp;</p>

<p class="MsoNormal"><b>About the author</b></p>

<p class="MsoNormal">Amit Klein is a renowned web application security
researcher. Mr. Klein has written many research papers on various web
application technologies--from HTTP to XML, SOAP and web services--and covered
many topics--HTTP request smuggling, insecure indexing, blind XPath injection,
HTTP response splitting, securing .NET web applications, cross site scripting,
cookie poisoning and more. His works have been published in Dr. Dobb's Journal,
SC Magazine, ISSA journal, and IT Audit journal; have been presented at SANS
and CERT conferences; and are used and referenced in many academic syllabi.</p>

<p class="MsoNormal">Mr. Klein is WASC (Web Application Security Consortium)
member.</p>

<p class="MsoNormal">&nbsp;</p>

</div>




</body></html>